{% extends "base.html" %}
{% block title %}Book Appointment{% endblock %}
{% block content %}
<h1 class="mb-4">Book Appointment</h1>

<a href="{{ url_for('patient_dashboard') }}" class="btn btn-outline-secondary mb-3">‚Üê Back to Dashboard</a>

<p class="lead">Select a specific 30-minute time slot from the available options below.</p>

{% if doctors %}
    {% for doctor in doctors %}
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <h4>Dr. {{ doctor.user.name }} <span class="badge bg-secondary">{{ doctor.specialization.name }}</span></h4>
        </div>
        <div class="card-body">
            <p>**Contact:** {{ doctor.user.contact_info or 'N/A' }}</p>
            
            <h5>Available Slots (Next 7 Days)</h5>
            <div class="row">
                {% for date_str in date_list %}
                
                {# Retrieve the list of available 30-minute slots for this doctor/date #}
                {% set slots = bookable_slots_map.get(doctor.user_id, {}).get(date_str, []) %}
                
                <div class="col-md-3 mb-3">
                    <div class="p-2 border rounded 
                        {% if slots %} bg-info text-white {% else %} bg-light text-muted {% endif %}">
                        
                        <strong>{{ datetime.strptime(date_str, '%Y-%m-%d').strftime('%a, %b %d') }}</strong>
                        
                        {% if slots %}
                            {% for slot_time in slots %}
                                <form method="POST" action="{{ url_for('book_appointment') }}" class="d-inline-block mt-1 w-100">
                                    <input type="hidden" name="doctor_id" value="{{ doctor.user_id }}">
                                    <input type="hidden" name="date" value="{{ date_str }}">
                                    
                                    <input type="hidden" name="time" value="{{ slot_time }}"> 
                                    
                                    <input type="hidden" name="specialization_id" value="{{ current_spec_id }}">
                                    <button type="submit" class="btn btn-sm btn-light w-100 mb-1">Book {{ slot_time }}</button>
                                </form>
                            {% endfor %}
                        {% else %}
                            <p class="m-0 small">Unavailable/Fully Booked</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="alert alert-warning">No doctors found for the selected specialization or time frame.</div>
{% endif %}

{% endblock %}
